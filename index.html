<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comparison of Vital Signs between Survivors and Non-Survivors of Exploratory Laproscopy</title>
  <!-- Using D3 v5 -->
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      /* Removed max-width: 1200px; so the page can grow wider */
      padding: 20px;
      color: #333;
      line-height: 1.6;
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
    }

    h1 {
      color: #2c3e50;
      margin-bottom: 5px;
      font-size: 1.8rem;
    }

    .authors {
      color: #7f8c8d;
      margin-top: 0;
      margin-bottom: 30px;
      font-style: italic;
    }

    /* Container to hold chart + sidebar */
    #main-container {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      width: 100%;
    }

    /* Chart container */
    #chart-container {
      flex: 1 1 auto;
      min-width: 600px;
      /* Increased this from 900px to 1200px */
      max-width: 1200px;
      margin-right: 20px;
    }

    /* Sidebar for key takeaways */
    #insights-panel {
      /* Narrowed from 220px to 180px */
      flex: 0 0 180px;
      border-left: 2px solid #f0f0f0;
      padding-left: 20px;
      margin-top: 50px;
    }

    #insights-panel h2 {
      font-size: 1.2rem;
      margin-top: 0;
      color: #2c3e50;
    }

    #insights-panel ul {
      list-style-type: disc;
      padding-left: 20px;
      margin: 10px 0;
    }

    #controls {
      width: 100%;
      margin: 20px 0;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #controls label {
      margin-right: 10px;
      font-weight: bold;
    }

    select {
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
      background-color: white;
      font-size: 14px;
      min-width: 200px;
    }

    #chart {
      position: relative;
      margin: 20px 0;
      padding: 0;
      background-color: transparent;
      border-radius: 0;
      box-shadow: none;
      width: 100%;
    }

    .tooltip {
      position: absolute;
      text-align: left;
      padding: 10px;
      font: 14px sans-serif;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #ddd;
      border-radius: 4px;
      pointer-events: none;
      opacity: 0;
      z-index: 10;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      transition: opacity 0.3s;
    }

    .tooltip-title {
      font-weight: bold;
      margin-bottom: 5px;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
    }

    .tooltip-group {
      margin-bottom: 8px;
    }

    .tooltip-group-title {
      font-weight: bold;
      color: #333;
    }

    .death-color {
      color: #e74c3c;
    }

    .survived-color {
      color: #2ecc71;
    }

    .hover-line {
      stroke: #7f8c8d;
      stroke-width: 1px;
      stroke-dasharray: 3, 3;
    }

    .axis-label {
      font-size: 12px;
      fill: #7f8c8d;
    }

    .chart-title {
      font-size: 16px;
      font-weight: bold;
      text-anchor: middle;
      fill: #2c3e50;
    }

    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 16px;
      color: #7f8c8d;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
        flex-direction: column;
      }
      #main-container {
        flex-direction: column;
      }
      #chart-container {
        margin-right: 0;
        max-width: 100% !important;
      }
      #insights-panel {
        border-left: none;
        border-top: 2px solid #f0f0f0;
        margin-top: 20px;
        padding-top: 20px;
      }
    }

    .survived-line {
      filter: drop-shadow(0px 0px 4px #2ecc71);
    }
  </style>
</head>
<body>

  <h1>Survival Signals: How Vital Signs Predict Life or Loss After Surgery</h1>
  <p class="footnote">*Exploratory laparoscopy is a minimally invasive procedure used to examine the abdominal organs
    and diagnose conditions.</p>

  <div id="controls">
    <label for="parameter-select">Choose a Vital Sign:</label>
    <select id="parameter-select">
      <option value="Solar8000/HR" selected>Heart Rate (HR)</option>
      <option value="Solar8000/ART_DBP">Arterial Diastolic Blood Pressure (DBP)</option>
      <option value="Solar8000/ART_MBP">Arterial Mean Blood Pressure (MBP)</option>
      <option value="Solar8000/ART_SBP">Arterial Systolic Blood Pressure (SBP)</option>
      <option value="Solar8000/ETCO2">End-Tidal CO2 (ETCO2)</option>
      <option value="Solar8000/PLETH_SPO2">Oxygen Saturation (SPO2)</option>
    </select>
  </div>

  <div id="main-container">
    <!-- Chart Section -->
    <div id="chart-container">
      <div id="chart">
        <div class="loading">Please select a parameter to display data</div>
      </div>
      <div class="tooltip" id="tooltip"></div>
    </div>

    <!-- Key Takeaways Sidebar -->
    <div id="insights-panel">
      <h2>Key Takeaways</h2>
      <div id="takeaways-content" style="margin-top:10px;">
        <!-- Populated dynamically via JavaScript -->
      </div>
    </div>
  </div>

  <script>
    // Provide short bullet points for each parameter
    const insightsByParameter = {
      "Solar8000/HR": `
        <ul>
          <li>Non-Survivors often show elevated HR beyond normal (75–95).</li>
          <li>Survivors stay closer to the normal band.</li>
          <li>High HR may reflect physiological stress or hemorrhage.</li>
        </ul>
      `,
      "Solar8000/ART_DBP": `
        <ul>
          <li>Normal diastolic range: 60–80 mmHg.</li>
          <li>Both groups track near normal initially; Non-Survivors dip below normal later.</li>
          <li>Survivors maintain higher DBP over time.</li>
        </ul>
      `,
      "Solar8000/ART_MBP": `
        <ul>
          <li>MAP normal range: 70–100 mmHg.</li>
          <li>Non-Survivors eventually fall below normal more frequently.</li>
          <li>Survivors keep MAP in normal range for longer, indicating better perfusion.</li>
        </ul>
      `,
      "Solar8000/ART_SBP": `
        <ul>
          <li>Normal systolic: 90–120 mmHg.</li>
          <li>Non-Survivors rise high then drop below normal, reflecting instability.</li>
          <li>Survivors show more stable systolic trends.</li>
        </ul>
      `,
      "Solar8000/ETCO2": `
        <ul>
          <li>Normal ETCO2: 35–45 mmHg.</li>
          <li>Non-Survivors’ ETCO2 drops sharply, indicating poor ventilation/perfusion.</li>
          <li>Survivors remain near normal until late in the timeline.</li>
        </ul>
      `,
      "Solar8000/PLETH_SPO2": `
        <ul>
          <li>Normal SpO2: 95–100%.</li>
          <li>Non-Survivors trend below 95% more often.</li>
          <li>Survivors stay consistently >95%, reflecting better oxygenation.</li>
        </ul>
      `
    };

    function drawChart(selectedParameter) {
      if (!selectedParameter) {
        d3.select("#chart").html('<div class="loading">Please select a parameter to display data</div>');
        return;
      }

      // Update Key Takeaways
      d3.select("#takeaways-content").html(insightsByParameter[selectedParameter] || "");

      // Show loading indicator
      d3.select("#chart").html('<div class="loading">Loading data...</div>');

      d3.json("vital_signs_data.json").then(function (rawData) {
        // Clear previous chart
        d3.select("#chart").html("");

        // Death group
        const deathData = rawData["Death"].flat().map(d => ({
          time: new Date(d.Time),
          value: +d[selectedParameter]
        })).filter(d => !isNaN(d.value));

        // Survived group
        const survivedData = rawData["Survived"].flat().map(d => ({
          time: new Date(d.Time),
          value: +d[selectedParameter]
        })).filter(d => !isNaN(d.value));

        // Cutoff: 10 PM on Dec 31, 1969
        const cutoffDate = new Date('1969-12-31T22:00:00');
        const filteredDeathData = deathData.filter(d => d.time < cutoffDate && d.time.getFullYear() === 1969);
        const filteredSurvivedData = survivedData.filter(d => d.time < cutoffDate && d.time.getFullYear() === 1969);

        // Downsample
        const every30thDeathData = filteredDeathData.filter((d, i) => i % 30 === 0);
        const every30thSurvivedData = filteredSurvivedData.filter((d, i) => i % 30 === 0);

        // Combined for domain
        const allData = every30thDeathData.concat(every30thSurvivedData);
        if (allData.length === 0) {
          d3.select("#chart").html('<div class="loading">No data available for this parameter.</div>');
          return;
        }

        // Parameter name (e.g. "HR")
        const parameterName = selectedParameter.split('/').pop();

        // Container dims
        const chartContainer = document.getElementById('chart');
        const containerWidth = chartContainer.clientWidth;
        // Bump the max possible width
        const width = Math.min(containerWidth - 20, 1400);
        const height = Math.min(window.innerHeight * 0.8, 700);
        const margin = { top: 60, right: 150, bottom: 80, left: 100 };

        // Data domain
        const dataMin = d3.min(allData, d => d.value);
        const dataMax = d3.max(allData, d => d.value);

        // Normal ranges
        const normalRanges = {
          "Solar8000/HR": [75, 95],
          "Solar8000/ART_DBP": [60, 80],
          "Solar8000/ART_MBP": [70, 100],
          "Solar8000/ART_SBP": [90, 120],
          "Solar8000/ETCO2": [35, 45],
          "Solar8000/PLETH_SPO2": [95, 100]
        };

        let yMin = dataMin * 0.95;
        let yMax = dataMax * 1.05;
        if (selectedParameter in normalRanges) {
          const [normalMin, normalMax] = normalRanges[selectedParameter];
          yMin = Math.min(yMin, normalMin * 0.95);
          yMax = Math.max(yMax, normalMax * 1.05);
        }

        // X / Y scales
        const x = d3.scaleTime()
          .domain(d3.extent(allData, d => d.time))
          .range([margin.left, width - margin.right]);

        const y = d3.scaleLinear()
          .domain([yMin, yMax])
          .nice()
          .range([height - margin.bottom, margin.top]);

        // Create SVG
        const svg = d3.select("#chart").append("svg")
          .attr("width", width)
          .attr("height", height)
          .attr("viewBox", `0 0 ${width} ${height}`)
          .attr("preserveAspectRatio", "xMidYMid meet");

        // Grid lines (vertical)
        svg.append("g")
          .attr("class", "grid")
          .attr("transform", `translate(0, ${height - margin.bottom})`)
          .call(d3.axisBottom(x)
            .tickSize(-(height - margin.top - margin.bottom))
            .tickFormat("")
          )
          .call(g => g.select(".domain").remove())
          .call(g => g.selectAll(".tick line")
            .attr("stroke", "#e0e0e0")
            .attr("stroke-opacity", 0.7)
          );

        // Grid lines (horizontal)
        svg.append("g")
          .attr("class", "grid")
          .attr("transform", `translate(${margin.left}, 0)`)
          .call(d3.axisLeft(y)
            .tickSize(-(width - margin.left - margin.right))
            .tickFormat("")
          )
          .call(g => g.select(".domain").remove())
          .call(g => g.selectAll(".tick line")
            .attr("stroke", "#e0e0e0")
            .attr("stroke-opacity", 0.7)
          );

        // Title
        svg.append("text")
          .attr("class", "chart-title")
          .attr("x", width / 2)
          .attr("y", margin.top / 2)
          .text(`${parameterName} Over Time`);

        // Axes
        svg.append("g")
          .attr("transform", `translate(0, ${height - margin.bottom})`)
          .call(d3.axisBottom(x).ticks(8))
          .call(g => g.select(".domain").attr("stroke", "#ccc"))
          .call(g => g.selectAll(".tick line").attr("stroke", "#ccc"))
          .call(g => g.selectAll(".tick text").attr("fill", "#666"));

        svg.append("g")
          .attr("transform", `translate(${margin.left}, 0)`)
          .call(d3.axisLeft(y))
          .call(g => g.select(".domain").attr("stroke", "#ccc"))
          .call(g => g.selectAll(".tick line").attr("stroke", "#ccc"))
          .call(g => g.selectAll(".tick text").attr("fill", "#666"));

        // Axis labels
        svg.append("text")
          .attr("class", "axis-label")
          .attr("text-anchor", "middle")
          .attr("x", width / 2)
          .attr("y", height - 10)
          .text("Time");

        svg.append("text")
          .attr("class", "axis-label")
          .attr("text-anchor", "middle")
          .attr("transform", "rotate(-90)")
          .attr("x", -(height / 2))
          .attr("y", 20)
          .text(parameterName);

        // Animate line helper
        function animateLine(path, duration, delay = 0) {
          const totalLength = path.node().getTotalLength();
          path
            .attr("stroke-dasharray", totalLength + " " + totalLength)
            .attr("stroke-dashoffset", totalLength)
            .transition()
            .delay(delay)
            .duration(duration)
            .ease(d3.easeLinear)
            .attr("stroke-dashoffset", 0);
        }

        // Time-based animation speed
        const totalTimeRange = x.domain()[1] - x.domain()[0];
        const baseAnimationDuration = 10000;
        const speedFactor = baseAnimationDuration / totalTimeRange;

        // Non-Survivors line
        const lineDeath = d3.line()
          .x(d => x(d.time))
          .y(d => y(d.value))
          .curve(d3.curveMonotoneX);

        const deathStartTime = d3.min(every30thDeathData, d => d.time);
        const deathEndTime = d3.max(every30thDeathData, d => d.time);
        const deathDuration = (deathEndTime - deathStartTime) * speedFactor;

        const deathLinePath = svg.append("path")
          .datum(every30thDeathData)
          .attr("class", "line death-line")
          .attr("d", lineDeath)
          .style("stroke", "#e74c3c")
          .style("stroke-width", 2)
          .style("fill", "none")
          .style("opacity", 0.8);

        animateLine(deathLinePath, deathDuration);

        // Survivors line
        const lineSurvived = d3.line()
          .x(d => x(d.time))
          .y(d => y(d.value))
          .curve(d3.curveMonotoneX);

        const survivedStartTime = d3.min(every30thSurvivedData, d => d.time);
        const survivedEndTime = d3.max(every30thSurvivedData, d => d.time);
        const survivedDuration = (survivedEndTime - survivedStartTime) * speedFactor;

        const survivedLinePath = svg.append("path")
          .datum(every30thSurvivedData)
          .attr("class", "line survived-line")
          .attr("d", lineSurvived)
          .style("stroke", "#2ecc71")
          .style("stroke-width", 2)
          .style("fill", "none")
          .style("opacity", 0.8);

        animateLine(survivedLinePath, survivedDuration);

        // "Time After Passing" region
        const deathTime = d3.max(every30thDeathData, d => d.time);
        let passingRegion, passingLabel;
        if (deathTime) {
          passingRegion = svg.append("rect")
            .attr("x", x(deathTime))
            .attr("y", margin.top)
            .attr("width", width - margin.right - x(deathTime))
            .attr("height", height - margin.top - margin.bottom)
            .style("fill", "#e74c3c")
            .style("opacity", 0);

          passingLabel = svg.append("text")
            .attr("x", x(deathTime) + 10)
            .attr("y", margin.top + 20)
            .attr("fill", "#e74c3c")
            .attr("font-size", "14px")
            .attr("font-weight", "bold")
            .style("opacity", 0)
            .text("Time After Passing");
        }
        setTimeout(() => {
          if (passingRegion) passingRegion.transition().duration(1000).style("opacity", 0.2);
          if (passingLabel) passingLabel.transition().duration(1000).style("opacity", 1);
        }, survivedDuration);

        // Normal range shading
        if (selectedParameter in normalRanges) {
          const [normalMin, normalMax] = normalRanges[selectedParameter];
          svg.append("rect")
            .attr("x", margin.left)
            .attr("y", y(normalMax))
            .attr("width", width - margin.left - margin.right)
            .attr("height", y(normalMin) - y(normalMax))
            .style("fill", "#3498db")
            .style("opacity", 0.15);

          svg.append("text")
            .attr("x", width - margin.right - 120)
            .attr("y", y(normalMax) - 5)
            .attr("fill", "#3498db")
            .attr("font-size", "12px")
            .attr("font-weight", "bold")
            .text("Normal Range");
        }

        // Hover interaction
        svg.append("rect")
          .attr("width", width - margin.left - margin.right)
          .attr("height", height - margin.top - margin.bottom)
          .attr("transform", `translate(${margin.left}, ${margin.top})`)
          .style("fill", "none")
          .style("pointer-events", "all")
          .on("mousemove", function() {
            const [mouseX] = d3.mouse(this);
            const mouseTime = x.invert(mouseX + margin.left);

            // Closest points
            const closestDeath = every30thDeathData.reduce((prev, curr) => {
              return (Math.abs(curr.time - mouseTime) < Math.abs(prev.time - mouseTime) ? curr : prev);
            }, every30thDeathData[0]);
            const closestSurvived = every30thSurvivedData.reduce((prev, curr) => {
              return (Math.abs(curr.time - mouseTime) < Math.abs(prev.time - mouseTime) ? curr : prev);
            }, every30thSurvivedData[0]);

            const formatTime = d3.timeFormat("%I:%M %p");
            let tooltipContent = "";
            if (closestDeath && closestSurvived) {
              tooltipContent = `
                <div class="tooltip-title">${parameterName} at ${formatTime(closestDeath.time)}</div>
                <div class="tooltip-group">
                  <div class="tooltip-group-title death-color">Non-Survivors</div>
                  <div>Value: <strong>${closestDeath.value.toFixed(1)}</strong></div>
                </div>
                <div class="tooltip-group">
                  <div class="tooltip-group-title survived-color">Survivors</div>
                  <div>Value: <strong>${closestSurvived.value.toFixed(1)}</strong></div>
                </div>
              `;
            }

            d3.select("#tooltip")
              .style("opacity", 1)
              .html(tooltipContent)
              .style("left", (d3.event.pageX + 15) + "px")
              .style("top", (d3.event.pageY - 28) + "px");

            // Hover line
            svg.selectAll(".hover-line").remove();
            svg.append("line")
              .attr("class", "hover-line")
              .attr("x1", mouseX + margin.left)
              .attr("x2", mouseX + margin.left)
              .attr("y1", margin.top)
              .attr("y2", height - margin.bottom);

            // Highlight circles
            svg.selectAll(".highlight-point").remove();
            if (closestDeath) {
              svg.append("circle")
                .attr("class", "highlight-point")
                .attr("cx", x(closestDeath.time))
                .attr("cy", y(closestDeath.value))
                .attr("r", 6)
                .style("fill", "none")
                .style("stroke", "#e74c3c")
                .style("stroke-width", 2);
            }
            if (closestSurvived) {
              svg.append("circle")
                .attr("class", "highlight-point")
                .attr("cx", x(closestSurvived.time))
                .attr("cy", y(closestSurvived.value))
                .attr("r", 6)
                .style("fill", "none")
                .style("stroke", "#2ecc71")
                .style("stroke-width", 2);
            }
          })
          .on("mouseout", function() {
            d3.select("#tooltip").style("opacity", 0);
            svg.selectAll(".hover-line").remove();
            svg.selectAll(".highlight-point").remove();
          });

        // Legend
        const legend = svg.append("g")
          .attr("transform", `translate(${width - margin.right + 20}, ${margin.top})`);

        // Death legend
        legend.append("rect")
          .attr("x", 0)
          .attr("y", 0)
          .attr("width", 15)
          .attr("height", 15)
          .style("fill", "#e74c3c")
          .style("opacity", 0.8);

        legend.append("text")
          .attr("x", 20)
          .attr("y", 12)
          .text("Non-Survivors")
          .style("font-size", "12px")
          .style("fill", "#333");

        // Survived legend
        legend.append("rect")
          .attr("x", 0)
          .attr("y", 30)
          .attr("width", 15)
          .attr("height", 15)
          .style("fill", "#2ecc71")
          .style("opacity", 0.8);

        legend.append("text")
          .attr("x", 20)
          .attr("y", 42)
          .text("Survivors")
          .style("font-size", "12px")
          .style("fill", "#333");

      }).catch(function (error) {
        console.error("Error loading data:", error);
        d3.select("#chart").html('<div class="loading">Error loading data. Please try again.</div>');
      });
    }

    // Initial draw
    drawChart(d3.select("#parameter-select").property("value"));

    // On parameter change
    d3.select("#parameter-select").on("change", function () {
      const selectedParameter = d3.select(this).property("value");
      drawChart(selectedParameter);
    });

    // Responsive
    window.addEventListener('resize', function () {
      const selectedParameter = d3.select("#parameter-select").property("value");
      if (selectedParameter) {
        drawChart(selectedParameter);
      }
    });
  </script>
</body>
</html>
