<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Greatest Differences Between Temperature and Activity for Female Mice Occur During Estrus</title>
  <!-- Using D3 v5 -->
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <style>
    body { font-family: sans-serif; margin-left:15%; margin-right:15%;}
    #controls { margin: 10px 0; }
    #controls label { margin-right: 20px; }
    #cycleControls { margin: 10px 0; }
    button { margin-left: 20px; }
    
    .tooltip {
      position: absolute;
      text-align: center;
      padding: 4px;
      font: 12px sans-serif;
      background: lightsteelblue;
      border: 0px;
      border-radius: 4px;
      pointer-events: none;
      opacity: 0; // Initially hidden
      z-index: 10; // Ensure it appears above other elements
    }
  </style>
</head>
<body>

  <h1>Final Project</h1>
  <p>By Hao Zhang, Kevin Zhang, Sarah He</p> 

  <div id="controls">
    <label for="parameter-select">Select Parameter:</label>
    <select id="parameter-select">
      <option value="" selected>-- Select a parameter --</option>
      <option value="Solar8000/HR">Solar8000/HR</option>
      <option value="Solar8000/ART_DBP">Solar8000/ART_DBP</option>
      <option value="Solar8000/ART_MBP">Solar8000/ART_MBP</option>
      <option value="Solar8000/ART_SBP">Solar8000/ART_SBP</option>
      <option value="Solar8000/ETCO2">Solar8000/ETCO2</option>
      <option value="Solar8000/PLETH_SPO2">Solar8000/PLETH_SPO2</option>
    </select>
  </div>

  <div id="chart"></div>
  <div class="tooltip" id="tooltip"></div> <!-- Tooltip div -->

  <script>
    // Function to draw the chart based on selected parameter
    function drawChart(selectedParameter) {
      d3.json("vital_signs_data.json").then(function(rawData) {
        // Flatten the nested lists for the Death group.
        const deathData = rawData["Death"].flat().map(d => ({
          time: new Date(d.Time),
          value: +d[selectedParameter] // Use the selected parameter
        }));

        // Flatten the nested lists for the Survived group.
        const survivedData = rawData["Survived"].flat().map(d => ({
          time: new Date(d.Time),
          value: +d[selectedParameter] // Use the selected parameter
        }));

        // Define the cutoff time (10 PM on December 31, 1969)
        const cutoffDate = new Date('1969-12-31T22:00:00'); // 10 PM on the last day of 1969

        // Filter the Death group data to include only entries before 10 PM on the last day of 1969
        const filteredDeathData = deathData.filter(d => d.time < cutoffDate && d.time.getFullYear() === 1969);

        // Filter the Survived group data to include only entries before 10 PM on the last day of 1969
        const filteredSurvivedData = survivedData.filter(d => d.time < cutoffDate && d.time.getFullYear() === 1969);

        // Select every 30th data point for Death group
        const every30thDeathData = filteredDeathData.filter((d, i) => i % 30 === 0);

        // Select every 30th data point for Survived group
        const every30thSurvivedData = filteredSurvivedData.filter((d, i) => i % 30 === 0);

        // Set dimensions.
        const width = 800, height = 400;
        const margin = { top: 20, right: 20, bottom: 30, left: 50 };

        // Set up scales.
        const x = d3.scaleTime()
          .domain(d3.extent(every30thDeathData.concat(every30thSurvivedData), d => d.time))
          .range([margin.left, width - margin.right]);

        const y = d3.scaleLinear()
          .domain([d3.min(every30thDeathData.concat(every30thSurvivedData), d => d.value), d3.max(every30thDeathData.concat(every30thSurvivedData), d => d.value)])
          .nice()
          .range([height - margin.bottom, margin.top]);

        // Create the SVG.
        const svg = d3.select("#chart").select("svg");
        if (svg.empty()) {
          svg = d3.select("#chart").append("svg")
            .attr("width", width)
            .attr("height", height);
        } else {
          svg.selectAll("*").remove(); // Clear previous content
        }

        // Add title
        svg.append("text")
          .attr("x", width / 2) // Center the title
          .attr("y", margin.top) // Position it at the top
          .attr("text-anchor", "middle") // Center the text
          .style("font-size", "16px") // Set font size
          .style("font-weight", "bold") // Make it bold
          .text(`Values Over Time for Death and Survived Groups - ${selectedParameter}`); // Title text

        // Add axes.
        svg.append("g")
          .attr("transform", `translate(0, ${height - margin.bottom})`)
          .call(d3.axisBottom(x));

        svg.append("g")
          .attr("transform", `translate(${margin.left}, 0)`)
          .call(d3.axisLeft(y));

        // Line generator for Death group.
        const lineDeath = d3.line()
          .x(d => x(d.time))
          .y(d => y(d.value));

        // Draw the line for Death group with a thinner stroke width and color.
        svg.append("path")
          .datum(every30thDeathData)
          .attr("class", "line")
          .attr("d", lineDeath)
          .style("stroke", "red") // Change to red for Death group
          .style("stroke-width", 1)
          .style("fill", "none");

        // Add scatter plot for Death group.
        svg.selectAll("circle.death")
          .data(every30thDeathData)
          .enter().append("circle")
          .attr("class", "death") // Class for Death group
          .attr("cx", d => x(d.time))
          .attr("cy", d => y(d.value))
          .attr("r", 2) // radius of the circles
          .style("fill", "red"); // color of the circles for Death group

        // Line generator for Survived group.
        const lineSurvived = d3.line()
          .x(d => x(d.time))
          .y(d => y(d.value));

        // Draw the line for Survived group with a thinner stroke width and color.
        svg.append("path")
          .datum(every30thSurvivedData)
          .attr("class", "line")
          .attr("d", lineSurvived)
          .style("stroke", "green") // Change to green for Survived group
          .style("stroke-width", 1)
          .style("fill", "none");

        // Add scatter plot for Survived group.
        svg.selectAll("circle.survived")
          .data(every30thSurvivedData) // Use the filtered data
          .enter().append("circle")
          .attr("class", "survived") // Class for Survived group
          .attr("cx", d => x(d.time))
          .attr("cy", d => y(d.value))
          .attr("r", 2) // radius of the circles
          .style("fill", "green"); // color of the circles for Survived group

        // Add a transparent rectangle to capture mouse events
        svg.append("rect")
          .attr("width", width - margin.left - margin.right)
          .attr("height", height - margin.top - margin.bottom)
          .attr("transform", `translate(${margin.left}, ${margin.top})`)
          .style("fill", "none") // Make it transparent
          .style("pointer-events", "all") // Allow pointer events
          .on("mousemove", function() {
            const mouseX = d3.mouse(this)[0]; // Get mouse x position using d3.mouse
            const mouseTime = x.invert(mouseX); // Convert x position to time

            // Find the closest data point for Death group
            const closestDeath = every30thDeathData.reduce((prev, curr) => {
              return (Math.abs(curr.time - mouseTime) < Math.abs(prev.time - mouseTime) ? curr : prev);
            });

            // Find the closest data point for Survived group
            const closestSurvived = every30thSurvivedData.reduce((prev, curr) => {
              return (Math.abs(curr.time - mouseTime) < Math.abs(prev.time - mouseTime) ? curr : prev);
            });

            // Update tooltip content
            d3.select("#tooltip")
              .style("opacity", 1)
              .html(`<strong>Death Group</strong><br>Value: ${closestDeath.value.toFixed(3)}<br>Time: ${closestDeath.time.toLocaleString()}<br><strong>Survived Group</strong><br>Value: ${closestSurvived.value.toFixed(3)}<br>Time: ${closestSurvived.time.toLocaleString()}`)
              .style("left", (d3.event.pageX + 5) + "px") // Use d3.event for mouse position
              .style("top", (d3.event.pageY - 28) + "px");

            // Add a vertical line
            svg.selectAll(".hover-line").remove(); // Remove any existing line
            svg.append("line")
              .attr("class", "hover-line")
              .attr("x1", mouseX + margin.left) // Adjust for margin
              .attr("x2", mouseX + margin.left) // Adjust for margin
              .attr("y1", margin.top)
              .attr("y2", height - margin.bottom)
              .style("stroke", "black")
              .style("stroke-opacity", 0.75)
              .style("stroke-width", 1);
          })
          .on("mouseout", function() {
            d3.select("#tooltip").style("opacity", 0);
            svg.selectAll(".hover-line").remove(); // Remove the line on mouse out
          });

        // Add legend
        const legend = svg.append("g")
          .attr("transform", `translate(${width - margin.right - 100}, ${margin.top})`); // Position the legend

        // Legend for Death group
        legend.append("rect")
          .attr("x", 0)
          .attr("y", 0)
          .attr("width", 15)
          .attr("height", 15)
          .style("fill", "red");

        legend.append("text")
          .attr("x", 20)
          .attr("y", 12)
          .text("Death Group")
          .style("font-size", "12px");

        // Legend for Survived group
        legend.append("rect")
          .attr("x", 0)
          .attr("y", 20)
          .attr("width", 15)
          .attr("height", 15)
          .style("fill", "green");

        legend.append("text")
          .attr("x", 20)
          .attr("y", 32)
          .text("Survived Group")
          .style("font-size", "12px");
      });
    }

    // Initial call to draw the chart with the default selected parameter
    drawChart(d3.select("#parameter-select").property("value"));

    // Event listener for dropdown change
    d3.select("#parameter-select").on("change", function() {
      const selectedParameter = d3.select(this).property("value");
      drawChart(selectedParameter); // Call the function to redraw the chart with the selected parameter
    });
    </script>
</div>
  <h1>Write Up</h1>
  <p>Lorem ipsum, dolor sit amet consectetur adipisicing elit. Facere exercitationem provident nam nemo saepe unde omnis quasi aliquam, ipsam dolore rerum. Laudantium atque sequi numquam ipsum quos, dignissimos distinctio assumenda.</p>

</body>
</html>
